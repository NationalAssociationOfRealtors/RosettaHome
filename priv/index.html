<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Test</title>
        <style>
            #messages div{
                transition: opacity 200ms;
            }

            #messages div:last-child{
                background-color: #FF0000;
            }

        </style>
        <link href="/static/vendor/bootstrap-3.3.6-dist/css/bootstrap.css" rel="stylesheet">
        <link href="/static/vendor/bootstrap-3.3.6-dist/css/bootstrap-theme.css" rel="stylesheet">
        <script src="/static/js/jquery-2.2.3.min.js"></script>
        <script src="/static/vendor/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-md-4">
                    <div class="thumbnail">
                        <img id="stream">
                        <div class="caption">
                            <div id="messages"></div>
                            <div class="btn-group" role="group" aria-label="...">
                                <button type="button" class="btn btn-default" onclick="on();">ON</button>
                                <button type="button" class="btn btn-default" onclick="off()">OFF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
    var events = [];
    var node_id = "1a0036000347343337373739";
    var user_id = Math.floor(Math.random()*10000000);

    function on(){
        var message = {type:"light", "data":"on"}
        websocket.send(JSON.stringify(message));
    }

    function off(){
        var message = {type:"light", "data":"off"}
        websocket.send(JSON.stringify(message));
    }

    function display_event(evt){
        console.log(evt.data);
        var messages = document.getElementById("messages");
        var len = messages.childNodes.length;
        if(len > events.length) messages.removeChild(messages.firstChild);
        var evnt = JSON.parse(evt.data);
        var v = evnt.value;
        try{
            v = JSON.stringify(v);
        }catch(e){
            v = v;
        }
        var e = document.createElement("div");
        e.innerHTML = evnt.type+": "+v;
        messages.appendChild(e);
        e.style.opacity = 0;
        window.getComputedStyle(e).opacity;
        e.style.opacity = 1;
    }

    $(document).ready(function(){
        $("#stream").attr("src", "http://localhost:8080/stream?node_id="+node_id+"&user_id="+user_id);
        websocket = new WebSocket('ws://localhost:8080/ws?node_id='+node_id+'&user_id='+user_id);
        websocket.onopen = function(evt) {
            console.log(evt);
        };
        websocket.onclose = function(evt) {
            console.log(evt)
        };
        websocket.onmessage = function(evt) {
            events.push(evt);
            if(events.length > 10) events.shift();
            display_event(evt);
        };
    });
    </script>
</html>
